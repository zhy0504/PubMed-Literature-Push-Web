# RQ Scheduler 配置说明

## 调度器扫描间隔配置

RQ Scheduler 使用扫描间隔来检查Redis中的调度任务，将到期任务移入执行队列。

### 配置方式

#### 方式一: 界面配置（推荐）⭐

1. 登录管理后台 → **系统设置** → **推送配置**
2. 调整 **RQ调度器扫描间隔**
3. 点击 **保存推送配置**
4. **重启调度器**使配置生效:
   ```bash
   docker compose restart scheduler
   ```

#### 方式二: 环境变量（高级）

在 `docker-compose.yml` 中设置:

```yaml
scheduler:
  environment:
    - RQ_SCHEDULER_INTERVAL=300  # 直接指定秒数
```

**优先级**: 环境变量 > 数据库配置 > 默认值(300秒)

---

## 扫描间隔选项

| 间隔 | 秒数 | 推送延迟 | 适用场景 | Redis负载 |
|------|------|----------|----------|-----------|
| 每1分钟 | 60秒 | 最多1分钟 | 高精度需求 | 较高 |
| 每3分钟 | 180秒 | 最多3分钟 | 平衡方案 | 中等 |
| **每5分钟** | **300秒** | **最多5分钟** | **推荐** ⭐ | **适中** |
| 每10分钟 | 600秒 | 最多10分钟 | 低频推送 | 较低 |
| 每15分钟 | 900秒 | 最多15分钟 | 定时推送 | 低 |
| 每30分钟 | 1800秒 | 最多30分钟 | 宽松调度 | 很低 |
| 每1小时 | 3600秒 | 最多1小时 | 低精度 | 最低 |

---

## 工作原理

### RQ Scheduler 调度流程

```
┌────────────────────────────────────────────────────────┐
│ Redis 调度队列                                          │
├────────────────────────────────────────────────────────┤
│ • 订阅A: 2025-09-30 09:30:00                           │
│ • 订阅B: 2025-09-30 14:00:00                           │
│ • 订阅C: 2025-10-01 09:00:00                           │
└────────────────────────────────────────────────────────┘
                    ↓
        ┌───────────────────────┐
        │   RQ Scheduler        │
        │ 每5分钟扫描一次        │
        └───────────────────────┘
                    ↓
    ┌─────────────────────────────────┐
    │  检查到期任务 (current_time)    │
    ├─────────────────────────────────┤
    │  if task.scheduled_time <= now: │
    │      queue.enqueue(task)        │
    │      redis.remove(task)         │
    └─────────────────────────────────┘
                    ↓
        ┌───────────────────────┐
        │   RQ Worker           │
        │ 立即执行推送任务       │
        └───────────────────────┘
```

### 推送时间示例

**场景**: 用户设置订阅在 **09:30** 推送

**扫描间隔**: 5分钟 (300秒)

**实际执行**:
```
09:25 → 扫描 → 09:30未到 → 跳过
09:30 → 扫描 → 09:30已到 → 移入队列 → Worker立即执行
09:35 → 扫描 → (任务已移除)
```

**推送延迟**: 0-5分钟之间

---

## 内部心跳机制

你可能会在日志中看到：

```
DEBUG - Sleeping 10.00 seconds
DEBUG - Checking for scheduled jobs
```

**说明**:
- **10秒心跳**: RQ Scheduler 的内部机制（固定，无法修改）
- **作用**: 保持调度器活跃，快速响应停止信号
- **不影响**: 实际任务检查间隔（由 `RQ_SCHEDULER_INTERVAL` 控制）

**关系图**:
```
心跳循环 (每10秒):
├─ 发送心跳信号
├─ 检查是否到达扫描时间
│  ├─ 未到 → 继续等待
│  └─ 已到 → 扫描任务 (每300秒)
└─ 继续下一个心跳
```

---

## 性能影响分析

### 扫描间隔对比

```
间隔1分钟:
├─ 优点: 最精确 (延迟≤1分钟)
├─ 缺点: Redis扫描频繁
└─ 适用: 推送时间要求严格的场景

间隔5分钟 (推荐):
├─ 优点: 平衡精度和性能
├─ 缺点: 可能延迟1-5分钟
└─ 适用: 大多数场景

间隔1小时:
├─ 优点: Redis负载最低
├─ 缺点: 可能延迟较大
└─ 适用: 对推送时间不敏感的场景
```

### Redis负载估算

**假设**: 100个活跃订阅

| 扫描间隔 | 每天扫描次数 | Redis操作 |
|---------|-------------|----------|
| 1分钟 | 1440次 | ~144,000次 |
| 5分钟 | 288次 | ~28,800次 |
| 1小时 | 24次 | ~2,400次 |

**结论**: 5分钟间隔是性能和精度的最佳平衡点

---

## 配置变更步骤

### 1. 修改配置

**界面方式**:
1. 管理后台 → 系统设置 → 推送配置
2. 选择新的扫描间隔
3. 保存配置

**环境变量方式**:
```yaml
# docker-compose.yml
scheduler:
  environment:
    - RQ_SCHEDULER_INTERVAL=180  # 改为3分钟
```

### 2. 重启调度器

```bash
# 重启调度器容器
docker compose restart scheduler

# 或重启所有服务
docker compose restart
```

### 3. 验证配置

查看调度器日志:
```bash
docker compose logs scheduler | grep "检查间隔"
```

应该看到:
```
启动RQ Scheduler: pubmed-scheduler-prod
检查间隔: 180秒 (3.0分钟)
配置来源: 数据库配置
```

---

## 常见问题

### Q: 修改配置后没有生效？

**A**: 需要重启调度器容器:
```bash
docker compose restart scheduler
```

### Q: 环境变量和数据库配置冲突？

**A**: 优先级顺序为:
1. 环境变量 `RQ_SCHEDULER_INTERVAL` (最高)
2. 数据库配置 `push_check_frequency`
3. 默认值 300秒

建议: 移除环境变量，使用界面配置

### Q: 如何选择合适的扫描间隔？

**A**: 根据需求选择:
- **高精度**: 1-3分钟 (延迟小，负载高)
- **平衡**: 5分钟 (推荐，延迟可接受)
- **低频**: 15-60分钟 (延迟大，负载低)

### Q: 10秒心跳是否太频繁？

**A**: 这是正常的内部机制，不会影响性能:
- 心跳只是简单的状态检查
- 实际任务扫描按 `RQ_SCHEDULER_INTERVAL` 执行
- 无法修改，也无需修改

---

## 监控和调试

### 查看调度器状态

```bash
# 查看日志
docker compose logs -f scheduler

# 查看Redis中的调度任务
docker compose exec redis redis-cli keys "rq:scheduler*"

# 查看任务详情
docker compose exec app python -c "
from rq_config import scheduler
jobs = list(scheduler.get_jobs())
print(f'调度任务数: {len(jobs)}')
for job in jobs:
    print(f'  {job.id} -> {job.scheduled_time}')
"
```

### 使用RQ Dashboard

访问: http://localhost:9181

- 查看所有队列状态
- 监控Worker工作状态
- 查看调度任务列表
- 分析任务执行历史

---

## 最佳实践

1. **使用界面配置**: 便于动态调整，无需修改代码
2. **选择5分钟间隔**: 大多数场景的最佳平衡点
3. **监控日志**: 定期检查调度器日志，确保正常运行
4. **重启生效**: 修改配置后务必重启调度器
5. **避免过短间隔**: 除非必要，不建议低于1分钟

---

## 相关文档

- [DOCKER_RQ_GUIDE.md](./DOCKER_RQ_GUIDE.md) - Docker部署完整指南
- [SCHEDULER_COMPARISON.md](./SCHEDULER_COMPARISON.md) - 新旧调度系统对比
- [rq_config.py](./rq_config.py) - RQ配置代码
- [rq_scheduler_runner.py](./rq_scheduler_runner.py) - 调度器启动脚本